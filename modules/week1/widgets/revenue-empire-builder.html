<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue Empire Builder - 5-Year Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-neutral-50: #fafafa;
            --color-neutral-100: #f5f5f5;
            --color-neutral-200: #e5e5e5;
            --color-neutral-300: #d4d4d4;
            --color-neutral-400: #a3a3a3;
            --color-neutral-500: #737373;
            --color-neutral-600: #525252;
            --color-neutral-700: #404040;
            --color-neutral-800: #262626;
            --color-neutral-900: #171717;
            --color-accent: #6b9085;
            --color-accent-light: #c0d1cd;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-green: #c0d1cd;
            --color-turquoise: #bfe5e7;
            --color-sand: #f0ede0;
            --font-family-primary: 'Geist', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-primary);
            background: var(--color-neutral-50);
            color: var(--color-neutral-900);
            padding: 1.5rem;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            color: var(--color-neutral-900);
            margin-bottom: 0.25rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .subtitle {
            color: var(--color-neutral-500);
            margin-bottom: 1.5rem;
            font-size: 0.95rem;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .intro-screen {
            background: white;
            border: 1px solid var(--color-neutral-200);
            border-radius: 12px;
            padding: 2rem;
            max-width: 700px;
            margin: 0 auto;
        }

        .intro-screen h2 {
            color: var(--color-neutral-900);
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .intro-screen p {
            color: var(--color-neutral-600);
            margin-bottom: 1rem;
            line-height: 1.7;
            font-size: 1rem;
        }

        .scenario-box {
            background: var(--color-neutral-50);
            border: 1px solid var(--color-neutral-200);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.5rem 0;
        }

        .scenario-box h3 {
            color: var(--color-neutral-900);
            margin-bottom: 0.75rem;
            font-size: 1.1rem;
        }

        .scenario-box ul {
            margin-left: 1.25rem;
            color: var(--color-neutral-700);
            line-height: 1.7;
        }

        .btn {
            background: var(--color-neutral-900);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-block;
        }

        .btn:hover {
            background: var(--color-neutral-700);
            transform: translateY(-1px);
        }

        .btn:focus {
            outline: 3px solid var(--color-neutral-500);
            outline-offset: 2px;
        }

        .btn:disabled {
            background: var(--color-neutral-300);
            cursor: not-allowed;
            transform: none;
        }

        .year-header {
            background: var(--color-neutral-900);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
        }

        .year-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .year-header .context {
            font-size: 1rem;
            color: var(--color-neutral-200);
            font-weight: 500;
        }

        .year-header .revenue-baseline {
            font-size: 0.9rem;
            color: var(--color-neutral-400);
            margin-top: 0.25rem;
        }

        .year-content {
            background: white;
            border: 1px solid var(--color-neutral-200);
            border-top: none;
            border-radius: 0 0 12px 12px;
            padding: 1.5rem;
        }

        /* Current Revenue Status */
        .revenue-status {
            background: var(--color-turquoise);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .revenue-status-item {
            text-align: center;
        }

        .revenue-status-label {
            font-size: 0.75rem;
            color: var(--color-neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .revenue-status-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-neutral-900);
        }

        .revenue-status-value.highlight {
            color: var(--color-success);
        }

        /* Event Branch */
        .event-branch {
            background: var(--color-sand);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .event-branch h3 {
            font-size: 1rem;
            color: var(--color-neutral-800);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .event-type-badge {
            display: inline-block;
            background: var(--color-neutral-800);
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-description {
            color: var(--color-neutral-600);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .event-choices {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .event-choice {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .event-choice:hover {
            border-color: var(--color-neutral-400);
        }

        .event-choice.selected {
            border-color: var(--color-neutral-900);
            background: var(--color-neutral-50);
        }

        .event-choice input[type="radio"] {
            margin-top: 0.2rem;
            width: 18px;
            height: 18px;
            accent-color: var(--color-neutral-900);
        }

        .event-choice-content {
            flex: 1;
        }

        .event-choice-title {
            font-weight: 600;
            color: var(--color-neutral-900);
            margin-bottom: 0.25rem;
        }

        .event-choice-impact {
            font-size: 0.8rem;
            color: var(--color-neutral-500);
        }

        .event-choice-details {
            font-size: 0.7rem;
            color: var(--color-neutral-400);
            font-style: italic;
            margin-top: 0.25rem;
        }

        .stream-cap-note {
            font-size: 0.7rem;
            color: var(--color-warning);
            margin-top: 0.25rem;
            font-style: italic;
        }

        .cap-badge {
            display: inline-block;
            background: var(--color-warning);
            color: var(--color-neutral-800);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem;
        }

        .stream-projected.at-cap {
            color: var(--color-warning);
        }

        .capacity-alert {
            background: linear-gradient(90deg, var(--color-warning), #fbbf24);
            color: var(--color-neutral-900);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            font-weight: 500;
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .capacity-alert.visible {
            display: flex;
        }

        .capacity-alert-icon {
            font-size: 1.1rem;
        }

        .capacity-alert strong {
            font-weight: 700;
        }

        /* Stream Cards */
        .streams-section h3 {
            font-size: 1rem;
            color: var(--color-neutral-700);
            margin-bottom: 0.5rem;
        }

        .streams-section .section-description {
            font-size: 0.85rem;
            color: var(--color-neutral-500);
            margin-bottom: 1rem;
        }

        .stream-card {
            background: white;
            border: 1px solid var(--color-neutral-200);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .stream-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .stream-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-neutral-900);
        }

        .stream-growth {
            font-size: 0.8rem;
            color: var(--color-neutral-500);
        }

        .event-impact-summary {
            background: var(--color-turquoise);
            border: 1px solid #8fd4d8;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .event-impact-summary h4 {
            font-size: 0.85rem;
            color: var(--color-neutral-800);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .event-impact-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem 1rem;
        }

        .event-impact-item {
            font-size: 0.85rem;
            color: var(--color-neutral-700);
        }

        .event-impact-item.positive {
            color: #059669;
        }

        .event-impact-item.negative {
            color: #dc2626;
        }

        .stream-row {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stream-current {
            min-width: 90px;
            font-size: 0.85rem;
            color: var(--color-neutral-600);
        }

        .slider-container {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .focus-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--color-neutral-300);
            background: white;
            border-radius: 4px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-neutral-700);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .focus-btn:hover {
            background: var(--color-neutral-100);
            border-color: var(--color-neutral-400);
        }

        .focus-btn:active {
            background: var(--color-neutral-200);
            transform: scale(0.95);
        }

        .focus-btn:focus {
            outline: 2px solid var(--color-neutral-500);
            outline-offset: 1px;
        }

        .focus-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .slider {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--color-neutral-200);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-neutral-900);
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-neutral-900);
            cursor: pointer;
            border: none;
        }

        .slider:focus {
            outline: 3px solid var(--color-neutral-500);
            outline-offset: 2px;
        }

        .focus-display {
            min-width: 50px;
            text-align: right;
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--color-neutral-900);
        }

        .stream-projected {
            min-width: 100px;
            text-align: right;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-success);
        }

        .stream-projected.at-cap {
            color: var(--color-warning);
        }

        .cap-badge {
            display: inline-block;
            background: var(--color-warning);
            color: var(--color-neutral-900);
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            margin-left: 0.25rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-neutral-900);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .toast.show {
            opacity: 1;
        }

        /* Summary Section */
        .projection-summary {
            background: var(--color-neutral-900);
            color: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-top: 1.5rem;
        }

        .projection-summary h4 {
            font-size: 0.85rem;
            color: var(--color-neutral-400);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 1rem;
        }

        .projection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .projection-item {
            text-align: center;
        }

        .projection-label {
            font-size: 0.75rem;
            color: var(--color-neutral-400);
            margin-bottom: 0.25rem;
        }

        .projection-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .projection-value.revenue { color: var(--color-success); }
        .projection-value.growth { color: var(--color-turquoise); }
        .projection-value.risk { color: var(--color-sand); }

        .focus-warning {
            background: var(--color-warning);
            color: var(--color-neutral-900);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-top: 1rem;
            text-align: center;
        }

        .action-row {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* Results Screen */
        .results-screen {
            background: white;
            border: 1px solid var(--color-neutral-200);
            border-radius: 12px;
            padding: 2rem;
        }

        .final-score {
            text-align: center;
            margin-bottom: 2rem;
        }

        .final-score h2 {
            font-size: 1.75rem;
            color: var(--color-neutral-900);
            margin-bottom: 0.5rem;
        }

        .score-value {
            font-size: 3rem;
            font-weight: 700;
            color: var(--color-neutral-800);
        }

        .score-label {
            font-size: 1rem;
            color: var(--color-neutral-500);
        }

        .performance-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .performance-card {
            background: var(--color-neutral-50);
            border: 1px solid var(--color-neutral-200);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .performance-card h3 {
            color: var(--color-neutral-500);
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .performance-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-neutral-900);
        }

        /* Revenue Trajectory */
        .trajectory-section {
            background: var(--color-neutral-50);
            border: 1px solid var(--color-neutral-200);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .trajectory-section h3 {
            font-size: 1rem;
            color: var(--color-neutral-800);
            margin-bottom: 1rem;
        }

        .trajectory-bar {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            height: 120px;
            gap: 0.5rem;
        }

        .trajectory-year {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .trajectory-fill {
            width: 100%;
            background: var(--color-neutral-800);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
        }

        .trajectory-label {
            font-size: 0.75rem;
            color: var(--color-neutral-500);
            margin-top: 0.5rem;
        }

        .trajectory-amount {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--color-neutral-700);
            margin-top: 0.25rem;
        }

        .insights {
            background: var(--color-neutral-50);
            border: 1px solid var(--color-neutral-200);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .insights h3 {
            color: var(--color-neutral-900);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .insights ul {
            margin-left: 1.25rem;
            color: var(--color-neutral-600);
            line-height: 1.8;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn-secondary {
            background: white;
            color: var(--color-neutral-900);
            border: 2px solid var(--color-neutral-300);
        }

        .btn-secondary:hover {
            background: var(--color-neutral-50);
            border-color: var(--color-neutral-900);
        }

        /* Ecosystem Cascade Panel */
        .cascade-panel {
            background: linear-gradient(135deg, var(--color-green) 0%, var(--color-turquoise) 100%);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .cascade-panel h4 {
            font-size: 0.9rem;
            color: var(--color-neutral-800);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cascade-flows {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cascade-flow {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--color-neutral-700);
            background: rgba(255,255,255,0.6);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            flex-wrap: wrap;
        }

        .cascade-source {
            font-weight: 600;
            color: var(--color-neutral-800);
            min-width: 100px;
        }

        .cascade-arrow {
            color: var(--color-neutral-400);
        }

        .cascade-targets {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem 0.5rem;
        }

        .cascade-target {
            color: #059669;
            font-weight: 500;
        }

        .cascade-total {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.1);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-neutral-800);
        }

        .cascade-total-value {
            color: #059669;
        }

        @media (max-width: 768px) {
            body { padding: 1rem; }
            .performance-grid { grid-template-columns: 1fr; }
            .projection-grid { grid-template-columns: 1fr; gap: 0.75rem; }
            .revenue-status { flex-direction: column; }
            .stream-row { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Revenue Empire Builder</h1>
        <p class="subtitle">Project your team's 5-year revenue growth through strategic decisions</p>

        <!-- Intro Screen -->
        <div class="screen active" id="intro-screen">
            <div class="intro-screen">
                <h2>Welcome, CFO!</h2>
                <p>You've been appointed Chief Financial Officer of a mid-market professional sports team generating <strong>$100M in annual revenue</strong>. Your mission: grow that revenue over 5 years through strategic focus across five revenue streams.</p>

                <div class="scenario-box">
                    <h3>Your Challenge:</h3>
                    <ul>
                        <li><strong>Starting Revenue:</strong> $100M annually across 5 streams</li>
                        <li><strong>Your Role:</strong> Decide where to focus resources each year</li>
                        <li><strong>Goal:</strong> Grow to $200+ million by Year 5</li>
                        <li><strong>Wildcards:</strong> Respond to market events that affect growth</li>
                    </ul>
                </div>

                <p><strong>Revenue Streams & Base Growth Rates:</strong></p>
                <ul style="margin-left: 1.25rem; color: var(--color-neutral-600); line-height: 1.7; margin-bottom: 1.5rem;">
                    <li><strong>Media Rights:</strong> $40M base (8% natural growth) - stable, long-term contracts</li>
                    <li><strong>Ticketing:</strong> $25M base (5% natural growth) - capacity-limited</li>
                    <li><strong>Sponsorship:</strong> $20M base (12% natural growth) - relationship-driven</li>
                    <li><strong>Merchandising:</strong> $10M base (10% natural growth) - performance-dependent</li>
                    <li><strong>Betting/Gaming:</strong> $5M base (35% natural growth) - high risk, high reward</li>
                </ul>

                <p style="color: var(--color-neutral-600); font-size: 0.9rem; margin-bottom: 1.5rem;"><strong>How focus works:</strong> Each stream grows naturally, but focusing resources (0-100%) amplifies that growth. Higher focus = higher potential growth, but also higher risk if that stream underperforms.</p>

                <button class="btn" onclick="startSimulation()" aria-label="Start the 5-year revenue simulation">Start Simulation</button>
            </div>
        </div>

        <!-- Year Screen -->
        <div class="screen" id="year-screen">
            <div class="year-header">
                <h2 id="year-title">Year 1: Set Your Growth Strategy</h2>
                <div class="context" id="year-context">Where will you focus resources to maximize revenue growth?</div>
                <div class="revenue-baseline" id="revenue-baseline">Current Annual Revenue: $100,000,000</div>
            </div>
            <div class="year-content">
                <!-- Current Revenue Status -->
                <div class="revenue-status" id="revenue-status">
                    <div class="revenue-status-item">
                        <div class="revenue-status-label">Current Revenue</div>
                        <div class="revenue-status-value" id="current-revenue">$100M</div>
                    </div>
                    <div class="revenue-status-item">
                        <div class="revenue-status-label">Year-over-Year</div>
                        <div class="revenue-status-value highlight" id="yoy-growth">Baseline</div>
                    </div>
                    <div class="revenue-status-item">
                        <div class="revenue-status-label">Target (Year 5)</div>
                        <div class="revenue-status-value" id="target-revenue">$200M+</div>
                    </div>
                </div>

                <!-- Event Branch (Years 2-5 only) -->
                <div class="event-branch" id="event-branch" style="display: none;">
                    <h3>
                        <span class="event-type-badge" id="event-type">Opportunity</span>
                        <span id="event-title">Market Event</span>
                    </h3>
                    <p class="event-description" id="event-description"></p>
                    <div class="event-choices" id="event-choices"></div>
                </div>

                <!-- Streams Section -->
                <div class="streams-section">
                    <h3 id="streams-header">Set Strategic Focus for Each Revenue Stream</h3>
                    <p class="section-description">Each stream has automatic base growth. Events (if any) apply additional multipliers. Use these sliders to add <strong>extra strategic focus</strong> on top‚Äîhigher focus amplifies growth (up to 1.5√ó) but increases risk exposure.</p>
                    <div id="event-impact-summary" style="display: none;"></div>
                    <div id="cascade-panel" class="cascade-panel" style="display: none;">
                        <h4>üîÑ Ecosystem Cascade Effects</h4>
                        <div id="cascade-content"></div>
                    </div>
                    <div id="streams-container"></div>
                </div>

                <!-- Projection Summary -->
                <div class="projection-summary">
                    <h4>Projected Year-End Results</h4>
                    <div class="projection-grid">
                        <div class="projection-item">
                            <div class="projection-label">Projected Revenue</div>
                            <div class="projection-value revenue" id="projected-revenue">$108M</div>
                        </div>
                        <div class="projection-item">
                            <div class="projection-label">Projected Growth</div>
                            <div class="projection-value growth" id="projected-growth">+8%</div>
                        </div>
                        <div class="projection-item">
                            <div class="projection-label">Risk Profile</div>
                            <div class="projection-value risk" id="risk-profile">Balanced</div>
                        </div>
                    </div>
                    <div class="focus-warning" id="focus-warning" style="display: none;">
                        Total focus should equal 100% for optimal resource allocation
                    </div>
                    <div class="capacity-alert" id="capacity-alert">
                        <span class="capacity-alert-icon">‚ö†Ô∏è</span>
                        <span id="capacity-alert-text">Ticketing approaching capacity ceiling</span>
                    </div>
                </div>

                <div class="action-row">
                    <button class="btn" id="confirm-btn" onclick="confirmYear()" aria-label="Confirm projection and proceed">Confirm Projection & Proceed to Year 2</button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="results-screen">
            <div class="results-screen">
                <div class="final-score">
                    <h2>5-Year Performance Summary</h2>
                    <div class="score-value" id="final-revenue">$0</div>
                    <div class="score-label">Final Annual Revenue (Year 5)</div>
                </div>

                <div class="performance-grid">
                    <div class="performance-card">
                        <h3>Total Growth</h3>
                        <div class="performance-value" id="final-growth">0%</div>
                    </div>
                    <div class="performance-card">
                        <h3>Avg Risk Taken</h3>
                        <div class="performance-value" id="final-risk">0</div>
                    </div>
                    <div class="performance-card">
                        <h3>Performance Grade</h3>
                        <div class="performance-value" id="final-grade">-</div>
                    </div>
                </div>

                <div class="trajectory-section">
                    <h3>Revenue Trajectory</h3>
                    <div class="trajectory-bar" id="trajectory-bar"></div>
                </div>

                <div class="insights">
                    <h3>Strategic Insights</h3>
                    <ul id="insights-list"></ul>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="location.reload()" aria-label="Restart simulation">Play Again</button>
                    <button class="btn" onclick="exportResults()" aria-label="Download summary">Download Summary</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const gameState = {
            currentYear: 1,
            baseRevenue: 100000000,
            currentRevenue: 100000000,
            revenueTrajectory: [100000000],
            selectedEventChoice: null,
            yearlyData: [],
            streams: [
                { id: 'media', name: 'Media Rights', baseValue: 40000000, baseGrowth: 0.08, focus: 20, riskFactor: 1, maxValue: 80000000, capNote: 'Contract-locked (9-12 year deals)' },
                { id: 'ticketing', name: 'Ticketing', baseValue: 25000000, baseGrowth: 0.05, focus: 20, riskFactor: 0.5, maxValue: 30000000, capNote: 'Capacity ceiling (~20K seats)' },
                { id: 'sponsorship', name: 'Sponsorship', baseValue: 20000000, baseGrowth: 0.12, focus: 20, riskFactor: 2, maxValue: null, capNote: null },
                { id: 'merchandising', name: 'Merchandising', baseValue: 10000000, baseGrowth: 0.10, focus: 20, riskFactor: 1.5, maxValue: null, capNote: null },
                { id: 'betting', name: 'Betting/Gaming', baseValue: 5000000, baseGrowth: 0.35, focus: 20, riskFactor: 3, maxValue: null, capNote: 'Regulatory risk' }
            ],
            events: {
                2: {
                    type: 'Opportunity',
                    title: 'Streaming Platform Deal',
                    description: 'A major streaming platform wants exclusive digital rights. This could boost media revenue but locks you into a 3-year contract.',
                    choices: [
                        { id: 'accept', title: 'Accept Exclusive Deal', impact: 'Media +20% growth this year', effects: { media: 1.20 } },
                        { id: 'decline', title: 'Keep Options Open', impact: 'No change, maintain flexibility', effects: {} },
                        { id: 'hybrid', title: 'Non-Exclusive Partnership', impact: 'Media +10% growth, lower commitment', effects: { media: 1.10 } }
                    ]
                },
                3: {
                    type: 'Opportunity',
                    title: 'Title Sponsorship Offer',
                    description: 'A Fortune 500 company offers a title sponsorship deal worth $8M/year, but requires category exclusivity.',
                    choices: [
                        { id: 'accept', title: 'Accept Title Sponsor', impact: 'Sponsorship +25% growth this year', effects: { sponsorship: 1.25 } },
                        { id: 'decline', title: 'Maintain Category Flexibility', impact: 'No change, keep options open', effects: {} },
                        { id: 'counter', title: 'Counter with Premium Tier', impact: 'Sponsorship +15% growth', effects: { sponsorship: 1.15 } }
                    ]
                },
                4: {
                    type: 'Crisis',
                    title: 'Economic Recession',
                    description: 'A recession hits. Consumer spending drops 15% and corporate marketing budgets are being slashed. How do you respond?',
                    choices: [
                        { id: 'invest', title: 'Double Down on Fan Experience', impact: 'Ticketing +10%, others flat', effects: { ticketing: 1.10, sponsorship: 0.90, merchandising: 0.90 } },
                        { id: 'cut', title: 'Defensive Positioning', impact: 'All streams -5%, preserve stability', effects: { media: 0.95, ticketing: 0.95, sponsorship: 0.95, merchandising: 0.95, betting: 0.95 } },
                        { id: 'pivot', title: 'Accelerate Digital/Betting', impact: 'Betting +40%, Sponsorship -15%', effects: { betting: 1.40, sponsorship: 0.85 } }
                    ]
                },
                5: {
                    type: 'Opportunity',
                    title: 'Championship Season',
                    description: 'Your team makes a deep playoff run! Fan engagement is at an all-time high. How do you capitalize?',
                    choices: [
                        { id: 'lock', title: 'Lock in Long-Term Deals', impact: 'All streams +12%, secure future', effects: { media: 1.12, ticketing: 1.12, sponsorship: 1.12, merchandising: 1.12, betting: 1.12 } },
                        { id: 'maximize', title: 'Maximize Short-Term', impact: 'Merch +50%, Ticketing +30%', effects: { merchandising: 1.50, ticketing: 1.30 } },
                        { id: 'balanced', title: 'Balanced Approach', impact: 'All streams +18%', effects: { media: 1.18, ticketing: 1.18, sponsorship: 1.18, merchandising: 1.18, betting: 1.18 } }
                    ]
                }
            }
        };

        // Ecosystem amplification: when you invest in stream X, stream Y benefits
        // This teaches the Connor McDavid principle: investment in one stream amplifies others
        const cascadeEffects = {
            ticketing: {
                // Star player investment / fan experience ‚Üí amplifies other streams
                media: 0.15,        // Better attendance ‚Üí better TV product
                merchandising: 0.25, // Engaged fans buy more gear
                betting: 0.20,      // Live attendance drives betting engagement
                sponsorship: 0.10   // Better atmosphere ‚Üí sponsor value
            },
            media: {
                // Better media exposure ‚Üí brand amplification
                sponsorship: 0.30,  // More eyeballs ‚Üí sponsor value increases
                merchandising: 0.15, // Broader reach ‚Üí more merchandise sales
                betting: 0.10       // Media integration drives betting
            },
            sponsorship: {
                // Sponsor activations ‚Üí fan engagement
                ticketing: 0.10,    // Sponsor promotions drive attendance
                merchandising: 0.08  // Co-branded merchandise
            },
            merchandising: {
                // Brand visibility ‚Üí minimal cascade
                media: 0.05         // Merchandise visibility = brand awareness
            },
            betting: {
                // Betting partnerships ‚Üí engagement
                media: 0.12,        // Betting content drives viewership
                ticketing: 0.08     // Betting promotions at venue
            }
        };

        function startSimulation() {
            // Initialize stream values
            gameState.streams.forEach(s => {
                s.currentValue = s.baseValue;
            });
            showScreen('year-screen');
            renderYear(1);
        }

        function renderYear(year) {
            gameState.currentYear = year;
            gameState.selectedEventChoice = null;

            // Keep previous year's focus settings (don't reset)

            // Update header
            if (year === 1) {
                document.getElementById('year-title').textContent = 'Year 1: Set Your Growth Strategy';
                document.getElementById('year-context').textContent = 'Where will you focus resources to maximize revenue growth?';
            } else {
                const event = gameState.events[year];
                document.getElementById('year-title').textContent = `Year ${year}: ${event.title}`;
                document.getElementById('year-context').textContent = 'Respond to the market event, then set your focus for the year.';
            }

            document.getElementById('revenue-baseline').textContent = `Current Annual Revenue: ${formatCurrency(gameState.currentRevenue)}`;

            // Update revenue status
            document.getElementById('current-revenue').textContent = formatShortCurrency(gameState.currentRevenue);
            if (year === 1) {
                document.getElementById('yoy-growth').textContent = 'Baseline';
            } else {
                const prevRevenue = gameState.revenueTrajectory[gameState.revenueTrajectory.length - 1];
                const growth = ((gameState.currentRevenue - gameState.baseRevenue) / gameState.baseRevenue * 100).toFixed(0);
                document.getElementById('yoy-growth').textContent = `+${growth}% from start`;
            }

            // Show/hide event branch
            if (year > 1) {
                renderEventBranch(year);
                document.getElementById('event-branch').style.display = 'block';
            } else {
                document.getElementById('event-branch').style.display = 'none';
            }

            // Hide event impact summary until choice is made
            document.getElementById('event-impact-summary').style.display = 'none';

            // Render stream focus sliders
            renderStreams();
            updateProjections();

            // Update button text
            const btnText = year < 5 ? `Confirm Projection & Proceed to Year ${year + 1}` : 'Confirm Projection & View Results';
            document.getElementById('confirm-btn').textContent = btnText;
        }

        function renderEventBranch(year) {
            const event = gameState.events[year];
            document.getElementById('event-type').textContent = event.type;
            document.getElementById('event-title').textContent = event.title;
            document.getElementById('event-description').textContent = event.description;

            const choicesContainer = document.getElementById('event-choices');
            choicesContainer.innerHTML = '';

            event.choices.forEach((choice) => {
                // Generate detailed effects string
                let detailsText = '';
                if (Object.keys(choice.effects).length > 0) {
                    const effectParts = Object.entries(choice.effects).map(([stream, mult]) => {
                        const pct = ((mult - 1) * 100).toFixed(0);
                        const sign = pct >= 0 ? '+' : '';
                        return `${stream}: ${sign}${pct}%`;
                    });
                    detailsText = `Effect: ${effectParts.join(', ')}`;
                } else {
                    detailsText = 'Effect: No multiplier changes';
                }

                const label = document.createElement('label');
                label.className = 'event-choice';
                label.innerHTML = `
                    <input type="radio" name="event-choice" value="${choice.id}" onchange="selectEventChoice('${choice.id}')">
                    <div class="event-choice-content">
                        <div class="event-choice-title">${choice.title}</div>
                        <div class="event-choice-impact">${choice.impact}</div>
                        <div class="event-choice-details">${detailsText}</div>
                    </div>
                `;
                choicesContainer.appendChild(label);
            });
        }

        function selectEventChoice(choiceId) {
            gameState.selectedEventChoice = choiceId;

            document.querySelectorAll('.event-choice').forEach(el => {
                el.classList.remove('selected');
                if (el.querySelector(`input[value="${choiceId}"]`)) {
                    el.classList.add('selected');
                }
            });

            // Show event impact in dollars
            showEventImpactSummary(choiceId);
            updateProjections();
        }

        function showEventImpactSummary(choiceId) {
            const summaryEl = document.getElementById('event-impact-summary');
            const event = gameState.events[gameState.currentYear];
            const choice = event.choices.find(c => c.id === choiceId);

            if (!choice || !choice.effects || Object.keys(choice.effects).length === 0) {
                summaryEl.style.display = 'none';
                return;
            }

            let impactItems = [];
            gameState.streams.forEach(stream => {
                const multiplier = choice.effects[stream.id];
                if (multiplier && multiplier !== 1) {
                    // Calculate dollar impact based on current value and base growth
                    const baseGrowthValue = stream.currentValue * stream.baseGrowth;
                    const eventImpact = stream.currentValue * (multiplier - 1);
                    const sign = eventImpact >= 0 ? '+' : '';
                    const cssClass = eventImpact >= 0 ? 'positive' : 'negative';
                    impactItems.push(`<span class="event-impact-item ${cssClass}">${stream.name}: ${sign}${formatShortCurrency(eventImpact)}</span>`);
                }
            });

            if (impactItems.length > 0) {
                summaryEl.innerHTML = `
                    <div class="event-impact-summary">
                        <h4>üìä Event Impact This Year (before your focus adjustments):</h4>
                        <div class="event-impact-list">${impactItems.join('')}</div>
                    </div>
                `;
                summaryEl.style.display = 'block';
            } else {
                summaryEl.style.display = 'none';
            }
        }

        function renderStreams() {
            const container = document.getElementById('streams-container');
            container.innerHTML = '';

            gameState.streams.forEach(stream => {
                const capNoteHtml = stream.capNote
                    ? `<div class="stream-cap-note">${stream.capNote}${stream.maxValue ? ` (max ~${formatShortCurrency(stream.maxValue)})` : ''}</div>`
                    : '';

                const card = document.createElement('div');
                card.className = 'stream-card';
                card.innerHTML = `
                    <div class="stream-header">
                        <span class="stream-title">${stream.name}</span>
                        <span class="stream-growth">Base growth: +${(stream.baseGrowth * 100).toFixed(0)}%/year</span>
                    </div>
                    <div class="stream-row">
                        <div class="stream-current">Now: ${formatShortCurrency(stream.currentValue)}</div>
                        <div class="slider-container">
                            <button type="button" class="focus-btn" onclick="adjustFocus('${stream.id}', -5)" aria-label="Decrease ${stream.name} focus by 5%">‚àí</button>
                            <input type="range" class="slider" id="slider-${stream.id}"
                                   min="0" max="100" step="5" value="${stream.focus}"
                                   oninput="updateFocus('${stream.id}', this.value)"
                                   aria-label="Set focus for ${stream.name}"
                                   title="0% = minimal growth (0.5x), 50% = base growth (1x), 100% = maximum growth (1.5x)">
                            <button type="button" class="focus-btn" onclick="adjustFocus('${stream.id}', 5)" aria-label="Increase ${stream.name} focus by 5%">+</button>
                            <div class="focus-display" id="focus-${stream.id}" title="Percentage of resources allocated to ${stream.name}">${stream.focus}%</div>
                        </div>
                        <div class="stream-projected" id="projected-${stream.id}">‚Üí ${formatShortCurrency(stream.currentValue * (1 + stream.baseGrowth))}</div>
                    </div>
                    ${capNoteHtml}
                `;
                container.appendChild(card);
            });
        }

        function updateFocus(streamId, value) {
            const stream = gameState.streams.find(s => s.id === streamId);
            stream.focus = parseInt(value);
            document.getElementById(`focus-${streamId}`).textContent = `${stream.focus}%`;
            updateProjections();
        }

        function adjustFocus(streamId, delta) {
            const stream = gameState.streams.find(s => s.id === streamId);
            const newValue = Math.max(0, Math.min(100, stream.focus + delta));
            stream.focus = newValue;
            document.getElementById(`slider-${streamId}`).value = newValue;
            document.getElementById(`focus-${streamId}`).textContent = `${newValue}%`;
            updateProjections();
        }

        function updateProjections() {
            const totalFocus = gameState.streams.reduce((sum, s) => sum + s.focus, 0);

            // Show warning if focus doesn't equal 100
            const warning = document.getElementById('focus-warning');
            if (totalFocus !== 100) {
                warning.style.display = 'block';
                const diff = totalFocus > 100 ? `${totalFocus - 100}% over` : `${100 - totalFocus}% under`;
                warning.textContent = `Total focus: ${totalFocus}% (${diff}) ‚Äî must equal exactly 100% to proceed`;
            } else {
                warning.style.display = 'none';
            }

            // ========== STEP 1: Calculate base growth with focus multiplier ==========
            let projectedValues = {};
            let baseGrowthValues = {};

            gameState.streams.forEach(stream => {
                // Original focus multiplier: 0% = 0.5√ó, 50% = 1.0√ó, 100% = 1.5√ó
                const focusMultiplier = 0.5 + (stream.focus / 100);
                let effectiveGrowth = stream.baseGrowth * focusMultiplier;

                // Apply event effects if selected
                if (gameState.currentYear > 1 && gameState.selectedEventChoice) {
                    const event = gameState.events[gameState.currentYear];
                    const choice = event.choices.find(c => c.id === gameState.selectedEventChoice);
                    if (choice && choice.effects && choice.effects[stream.id]) {
                        effectiveGrowth *= choice.effects[stream.id];
                    }
                }

                const projectedValue = stream.currentValue * (1 + effectiveGrowth);
                projectedValues[stream.id] = projectedValue;
                baseGrowthValues[stream.id] = stream.currentValue * effectiveGrowth;
            });

            // ========== STEP 2: Calculate cascade bonuses (THE KEY ADDITION) ==========
            const cascadeBonuses = {};
            const cascadeDetails = []; // For UI display

            gameState.streams.forEach(sourceStream => {
                const sourceFocus = sourceStream.focus / 100;

                // Only calculate cascade if stream has meaningful focus (>10%)
                if (sourceFocus > 0.1 && cascadeEffects[sourceStream.id]) {
                    const sourceInvestment = sourceStream.currentValue * sourceFocus;
                    const streamCascades = [];

                    Object.entries(cascadeEffects[sourceStream.id]).forEach(([targetId, multiplier]) => {
                        if (!cascadeBonuses[targetId]) cascadeBonuses[targetId] = 0;

                        // Cascade bonus = source investment √ó multiplier √ó source focus
                        // Focus appears twice: once in sourceInvestment, once as multiplier
                        // This rewards concentrated investment in ecosystem drivers
                        const cascadeBonus = sourceInvestment * multiplier * sourceFocus;
                        cascadeBonuses[targetId] += cascadeBonus;

                        if (cascadeBonus > 100000) { // Only show meaningful cascades (>$100K)
                            const targetStream = gameState.streams.find(s => s.id === targetId);
                            streamCascades.push({
                                target: targetStream.name,
                                bonus: cascadeBonus
                            });
                        }
                    });

                    if (streamCascades.length > 0) {
                        cascadeDetails.push({
                            source: sourceStream.name,
                            focus: sourceStream.focus,
                            targets: streamCascades
                        });
                    }
                }
            });

            // ========== STEP 3: Apply cascade bonuses to projected values ==========
            let totalCascadeBonus = 0;
            gameState.streams.forEach(stream => {
                if (cascadeBonuses[stream.id]) {
                    projectedValues[stream.id] += cascadeBonuses[stream.id];
                    totalCascadeBonus += cascadeBonuses[stream.id];
                }
            });

            // ========== STEP 4: Apply caps and update UI ==========
            let projectedTotal = 0;
            let weightedRisk = 0;
            let capacityWarnings = [];

            gameState.streams.forEach(stream => {
                let projectedValue = projectedValues[stream.id];

                // Apply cap if stream has a maximum value
                const atCap = stream.maxValue && projectedValue > stream.maxValue;
                if (atCap) {
                    projectedValue = stream.maxValue;
                }

                projectedTotal += projectedValue;

                // Update stream projected display
                const projectedEl = document.getElementById(`projected-${stream.id}`);
                if (projectedEl) {
                    const cascadeBonus = cascadeBonuses[stream.id] || 0;
                    if (atCap) {
                        projectedEl.innerHTML = `‚Üí ${formatShortCurrency(projectedValue)} <span class="cap-badge">capped</span>`;
                        projectedEl.classList.add('at-cap');
                    } else if (cascadeBonus > 100000) {
                        // Show cascade bonus inline
                        projectedEl.innerHTML = `‚Üí ${formatShortCurrency(projectedValue)} <span style="color:#059669;font-size:0.75rem;">(+${formatShortCurrency(cascadeBonus)} cascade)</span>`;
                        projectedEl.classList.remove('at-cap');
                    } else {
                        projectedEl.innerHTML = `‚Üí ${formatShortCurrency(projectedValue)}`;
                        projectedEl.classList.remove('at-cap');
                    }
                }

                // Calculate weighted risk
                weightedRisk += stream.riskFactor * (stream.focus / 100);

                // Track capacity warnings
                if (stream.maxValue) {
                    const projectedCapacity = projectedValue / stream.maxValue;
                    if (projectedCapacity >= 0.95) {
                        capacityWarnings.push({
                            stream: stream.name,
                            status: atCap ? 'at ceiling' : 'near ceiling (' + Math.round(projectedCapacity * 100) + '%)',
                            atCap: atCap
                        });
                    }
                }
            });

            // ========== STEP 5: Update cascade panel UI ==========
            updateCascadePanel(cascadeDetails, totalCascadeBonus);

            // Show capacity alert if any streams approaching/at cap
            const capacityAlert = document.getElementById('capacity-alert');
            const capacityAlertText = document.getElementById('capacity-alert-text');
            if (capacityWarnings.length > 0) {
                const warnings = capacityWarnings.map(w => `<strong>${w.stream}</strong> ${w.status}`).join(', ');
                capacityAlertText.innerHTML = warnings + ' ‚Äî growth limited by physical/contractual constraints';
                capacityAlert.classList.add('visible');
            } else {
                capacityAlert.classList.remove('visible');
            }

            // Update projection summary
            const growthPercent = ((projectedTotal - gameState.currentRevenue) / gameState.currentRevenue * 100).toFixed(0);
            document.getElementById('projected-revenue').textContent = formatShortCurrency(projectedTotal);
            document.getElementById('projected-growth').textContent = `+${growthPercent}%`;

            // Risk profile
            let riskLabel = 'Balanced';
            if (weightedRisk < 1) riskLabel = 'Conservative';
            else if (weightedRisk < 1.5) riskLabel = 'Moderate';
            else if (weightedRisk < 2) riskLabel = 'Balanced';
            else if (weightedRisk < 2.5) riskLabel = 'Aggressive';
            else riskLabel = 'Very Aggressive';
            document.getElementById('risk-profile').textContent = riskLabel;

            // Store cascade bonuses for confirmYear
            gameState.pendingCascadeBonuses = cascadeBonuses;
            gameState.pendingCascadeTotal = totalCascadeBonus;
        }

        function updateCascadePanel(cascadeDetails, totalBonus) {
            const panel = document.getElementById('cascade-panel');
            const content = document.getElementById('cascade-content');

            if (!panel || !content) return;

            if (cascadeDetails.length === 0 || totalBonus < 500000) {
                panel.style.display = 'none';
                return;
            }

            panel.style.display = 'block';

            let html = '<div class="cascade-flows">';

            cascadeDetails.forEach(detail => {
                const targetsHtml = detail.targets.map(t =>
                    `<span class="cascade-target">${t.target} +${formatShortCurrency(t.bonus)}</span>`
                ).join(', ');

                html += `
                    <div class="cascade-flow">
                        <span class="cascade-source">${detail.source} (${detail.focus}%)</span>
                        <span class="cascade-arrow">‚Üí</span>
                        <span class="cascade-targets">${targetsHtml}</span>
                    </div>
                `;
            });

            html += '</div>';

            html += `
                <div class="cascade-total">
                    Total Ecosystem Bonus: <span class="cascade-total-value">+${formatShortCurrency(totalBonus)}</span>
                </div>
            `;

            content.innerHTML = html;
        }

        function confirmYear() {
            const totalFocus = gameState.streams.reduce((sum, s) => sum + s.focus, 0);

            // Validation - must equal exactly 100%
            if (totalFocus !== 100) {
                alert(`Total focus must equal exactly 100%. Currently at ${totalFocus}%. Please adjust your allocation.`);
                return;
            }

            if (gameState.currentYear > 1 && !gameState.selectedEventChoice) {
                alert('Please select a response to the market event before proceeding.');
                return;
            }

            // ========== STEP 1: Calculate base growth ==========
            gameState.streams.forEach(stream => {
                const focusMultiplier = 0.5 + (stream.focus / 100);
                let effectiveGrowth = stream.baseGrowth * focusMultiplier;

                // Apply event effects
                if (gameState.currentYear > 1 && gameState.selectedEventChoice) {
                    const event = gameState.events[gameState.currentYear];
                    const choice = event.choices.find(c => c.id === gameState.selectedEventChoice);
                    if (choice && choice.effects && choice.effects[stream.id]) {
                        effectiveGrowth *= choice.effects[stream.id];
                    }
                }

                stream.currentValue = stream.currentValue * (1 + effectiveGrowth);
            });

            // ========== STEP 2: Apply cascade bonuses (THE KEY ADDITION) ==========
            const cascadeBonuses = {};

            gameState.streams.forEach(sourceStream => {
                const sourceFocus = sourceStream.focus / 100;
                const sourceInvestment = sourceStream.currentValue * sourceFocus;

                if (cascadeEffects[sourceStream.id]) {
                    Object.entries(cascadeEffects[sourceStream.id]).forEach(([targetId, multiplier]) => {
                        if (!cascadeBonuses[targetId]) cascadeBonuses[targetId] = 0;
                        cascadeBonuses[targetId] += sourceInvestment * multiplier * sourceFocus;
                    });
                }
            });

            // Apply cascade bonuses to stream values
            gameState.streams.forEach(stream => {
                if (cascadeBonuses[stream.id]) {
                    stream.currentValue += cascadeBonuses[stream.id];
                }

                // Apply cap if stream has a maximum value
                if (stream.maxValue && stream.currentValue > stream.maxValue) {
                    stream.currentValue = stream.maxValue;
                }
            });

            // ========== STEP 3: Calculate new total revenue ==========
            let newRevenue = gameState.streams.reduce((sum, s) => sum + s.currentValue, 0);

            // Save year data (including cascade info)
            const totalCascade = Object.values(cascadeBonuses).reduce((sum, b) => sum + b, 0);
            gameState.yearlyData.push({
                year: gameState.currentYear,
                startRevenue: gameState.currentRevenue,
                endRevenue: newRevenue,
                cascadeBonus: totalCascade,
                focus: gameState.streams.map(s => ({ id: s.id, name: s.name, focus: s.focus })),
                eventChoice: gameState.selectedEventChoice
            });

            gameState.currentRevenue = newRevenue;
            gameState.revenueTrajectory.push(newRevenue);

            // Next year or results
            if (gameState.currentYear < 5) {
                renderYear(gameState.currentYear + 1);
            } else {
                showResults();
            }
        }

        function showResults() {
            const initialRevenue = gameState.baseRevenue;
            const finalRevenue = gameState.currentRevenue;
            const growthPercent = ((finalRevenue - initialRevenue) / initialRevenue * 100).toFixed(1);

            // Calculate average risk
            const avgRisk = gameState.yearlyData.reduce((sum, y) => {
                const yearRisk = y.focus.reduce((r, f) => {
                    const stream = gameState.streams.find(s => s.id === f.id);
                    return r + (stream.riskFactor * (f.focus / 100));
                }, 0);
                return sum + yearRisk;
            }, 0) / gameState.yearlyData.length;

            // Grade
            let grade = 'F';
            if (finalRevenue >= 250000000) grade = 'A+';
            else if (finalRevenue >= 225000000) grade = 'A';
            else if (finalRevenue >= 200000000) grade = 'B+';
            else if (finalRevenue >= 175000000) grade = 'B';
            else if (finalRevenue >= 150000000) grade = 'C';
            else if (finalRevenue >= 125000000) grade = 'D';

            document.getElementById('final-revenue').textContent = formatCurrency(finalRevenue);
            document.getElementById('final-growth').textContent = `+${growthPercent}%`;
            document.getElementById('final-risk').textContent = avgRisk.toFixed(1) + '/3';
            document.getElementById('final-grade').textContent = grade;

            renderTrajectory();
            generateInsights(finalRevenue, avgRisk);
            showScreen('results-screen');
        }

        function renderTrajectory() {
            const container = document.getElementById('trajectory-bar');
            container.innerHTML = '';

            const maxRevenue = Math.max(...gameState.revenueTrajectory);

            gameState.revenueTrajectory.forEach((revenue, index) => {
                const year = document.createElement('div');
                year.className = 'trajectory-year';

                const heightPercent = (revenue / maxRevenue) * 100;
                year.innerHTML = `
                    <div class="trajectory-fill" style="height: ${heightPercent}%"></div>
                    <div class="trajectory-label">Year ${index}</div>
                    <div class="trajectory-amount">${formatShortCurrency(revenue)}</div>
                `;
                container.appendChild(year);
            });
        }

        function generateInsights(finalRevenue, avgRisk) {
            const insights = [];

            // Revenue-based insights
            if (finalRevenue >= 200000000) {
                insights.push('Excellent growth! You successfully grew revenue by over 100% through strategic ecosystem thinking.');
            } else if (finalRevenue >= 150000000) {
                insights.push('Good performance. Consider how investing in "ecosystem drivers" (ticketing, media) could amplify other streams.');
            } else {
                insights.push('Revenue growth was below target. Review how your focus allocation created (or missed) cascade effects.');
            }

            // ========== NEW: Ecosystem cascade insights ==========
            const totalCascade = gameState.yearlyData.reduce((sum, y) => sum + (y.cascadeBonus || 0), 0);

            if (totalCascade > 20000000) {
                insights.push(`Your ecosystem strategy generated +${formatShortCurrency(totalCascade)} in cascade effects over 5 years. This is strategic sports business thinking.`);
            } else if (totalCascade > 5000000) {
                insights.push(`Ecosystem effects contributed ${formatShortCurrency(totalCascade)} to your growth. Heavier investment in ticketing or media would amplify this further.`);
            } else {
                insights.push('Minimal ecosystem cascade effects. Spreading focus too thin prevents the amplification that comes from concentrated strategic investment.');
            }

            // Analyze ticketing focus (ecosystem driver)
            const avgTicketingFocus = gameState.yearlyData.reduce((sum, y) => {
                const ticketing = y.focus.find(f => f.id === 'ticketing');
                return sum + (ticketing ? ticketing.focus : 0);
            }, 0) / gameState.yearlyData.length;

            if (avgTicketingFocus >= 30) {
                insights.push('Strong ticketing/fan experience investment created cascade effects across merchandise, betting, and media‚Äîlike the Connor McDavid ecosystem amplification from Module 3.');
            }

            // Analyze betting focus
            const avgBettingFocus = gameState.yearlyData.reduce((sum, y) => {
                const betting = y.focus.find(f => f.id === 'betting');
                return sum + (betting ? betting.focus : 0);
            }, 0) / gameState.yearlyData.length;

            if (avgBettingFocus > 40) {
                insights.push('Heavy betting focus delivered high direct growth but limited cascade effects. Betting is a "receiver" not a "driver" in the revenue ecosystem.');
            }

            // Risk analysis
            if (avgRisk > 2) {
                insights.push('Your high-risk strategy created volatility. Consider balancing growth with ecosystem stability.');
            } else if (avgRisk < 1.2) {
                insights.push('Your conservative approach minimized risk but may have limited ecosystem amplification potential.');
            }

            // Event analysis
            const recessionChoice = gameState.yearlyData.find(y => y.year === 4);
            if (recessionChoice) {
                if (recessionChoice.eventChoice === 'pivot') {
                    insights.push('Pivoting to digital during the recession was a bold move that reshaped your revenue ecosystem.');
                } else if (recessionChoice.eventChoice === 'cut') {
                    insights.push('Your defensive positioning during the recession preserved stability but limited ecosystem growth.');
                }
            }

            const insightsList = document.getElementById('insights-list');
            insightsList.innerHTML = '';
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
            });
        }

        function exportResults() {
            let content = `REVENUE EMPIRE BUILDER - PERFORMANCE SUMMARY
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

FINAL RESULTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Starting Revenue (Year 0): ${formatCurrency(gameState.baseRevenue)}
Final Revenue (Year 5): ${formatCurrency(gameState.currentRevenue)}
Total Growth: +${((gameState.currentRevenue - gameState.baseRevenue) / gameState.baseRevenue * 100).toFixed(1)}%
Grade: ${document.getElementById('final-grade').textContent}

REVENUE TRAJECTORY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;
            gameState.revenueTrajectory.forEach((rev, i) => {
                content += `Year ${i}: ${formatCurrency(rev)}\n`;
            });

            content += `
YEARLY DECISIONS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;
            gameState.yearlyData.forEach(y => {
                content += `\nYear ${y.year}:\n`;
                content += `  Revenue: ${formatCurrency(y.startRevenue)} ‚Üí ${formatCurrency(y.endRevenue)}\n`;
                if (y.eventChoice) {
                    const event = gameState.events[y.year];
                    const choice = event.choices.find(c => c.id === y.eventChoice);
                    content += `  Event: ${event.title}\n`;
                    content += `  Decision: ${choice.title} (${choice.impact})\n`;
                }
                content += `  Focus Allocation:\n`;
                y.focus.forEach(f => {
                    content += `    - ${f.name}: ${f.focus}%\n`;
                });
            });

            content += `
ECOSYSTEM CASCADE ANALYSIS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;
            gameState.yearlyData.forEach(y => {
                if (y.cascadeBonus > 0) {
                    content += `Year ${y.year}: +${formatCurrency(y.cascadeBonus)} from ecosystem effects\n`;
                }
            });

            const totalCascade = gameState.yearlyData.reduce((sum, y) => sum + (y.cascadeBonus || 0), 0);
            content += `\nTotal 5-Year Cascade Value: ${formatCurrency(totalCascade)}\n`;

            content += `
STRATEGIC INSIGHTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
`;
            document.querySelectorAll('#insights-list li').forEach((li, i) => {
                content += `${i + 1}. ${li.textContent}\n`;
            });

            content += `
Generated: ${new Date().toLocaleString()}
Business of Sports Marketing - Week 1
`;

            // Try download first, fallback to clipboard
            try {
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'revenue-empire-results.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Summary downloaded!');
            } catch (downloadError) {
                // Fallback: copy to clipboard
                copyToClipboard(content);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Summary copied to clipboard!');
                }).catch(() => {
                    fallbackCopyToClipboard(text);
                });
            } else {
                fallbackCopyToClipboard(text);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showToast('Summary copied to clipboard!');
            } catch (err) {
                showToast('Could not copy. Please try again.');
            }
            document.body.removeChild(textarea);
        }

        function showToast(message) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString();
        }

        function formatShortCurrency(value) {
            if (value >= 1000000000) return '$' + (value / 1000000000).toFixed(1) + 'B';
            if (value >= 1000000) return '$' + (value / 1000000).toFixed(0) + 'M';
            return formatCurrency(value);
        }
    </script>
</body>
</html>
